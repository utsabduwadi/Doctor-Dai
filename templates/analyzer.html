{% extends "base.html" %}
{% block title %}Analyzer{% endblock %}
{% block content %}


<div class="an-wrap">
    <div class="an-head">
        <h1>Analyze Your Symptoms</h1>
        <p>Select your symptoms from the dropdown below and our model will predict potential diseases</p>
    </div>

    <div class="an-card">
        <form method="post" action="{{ url_for('analyzer_page') }}">
            <p class="sec-title">Select Your Symptoms</p>
            <p class="sec-sub">Choose all symptoms you are currently experiencing</p>

            <div class="picker" id="picker">
                <input id="search" class="search" type="text" placeholder="Search and select symptoms..."
                    autocomplete="off">
                <div id="drop" class="drop">
                    {% for symptom in symptom_options %}
                    <button type="button" class="opt{% if symptom.value in selected_symptoms %} active{% endif %}"
                        data-value="{{ symptom.value }}" data-label="{{ symptom.label }}">{{ symptom.label }}</button>
                    {% endfor %}
                </div>
            </div>

            <div id="chips" class="chips"></div>
            <div id="hidden-inputs"></div>
            <button type="submit" class="btn-main">Analyze Symptoms</button>
        </form>
    </div>

    <div class="results">
        <h2 class="res-title">Analysis Results</h2>
        <div class="grid">
            <div class="res-card">
                <p class="muted">Predicted Disease</p>
                <p class="pred">{{ prediction if prediction else "Submit symptoms to predict" }}</p>
                <p class="muted">Based on your selected symptoms, our model predicts possible conditions.</p>
            </div>

            <div class="res-card">
                <p class="muted">Top 3 Predicted Diseases</p>
                {% if top_predictions %}
                {% for item in top_predictions %}
                <div class="top-row">
                    <span>{{ loop.index }}. {{ item.disease }}</span>
                    <strong>{{ item.probability }}%</strong>
                </div>
                {% endfor %}
                {% else %}
                <p class="muted">Submit symptoms to view top predictions.</p>
                {% endif %}
            </div>
        </div>

        <div class="res-card" style="margin-top:14px">
            {% if recommended_doctors %}
            <div class="doctor-rec">
                {% for doctor in recommended_doctors %}
                <article class="doctor-row">
                    <p class="doctor-name">{{ doctor.name }}</p>
                    <p class="doctor-meta"><strong>Specialist:</strong> {{ doctor.name }}</p>
                    <p class="doctor-meta"><strong>Department:</strong> {{ doctor.department }}</p>
                    <p class="doctor-meta"><strong>Hospital:</strong> {{ doctor.hospital }}</p>
                    <p class="doctor-contact"><strong>Email:</strong> {{ doctor.email }} | <strong>Phone:</strong> {{ doctor.phone }}</p>
                </article>
                {% endfor %}
            </div>
            {% else %}
            <p class="muted">Submit symptoms to view doctor recommendations.</p>
            {% endif %}
        </div>

        <div class="warn-card">
            This is an AI prediction and should not replace professional medical advice. Please consult with a
            healthcare provider for accurate diagnosis.
        </div>
    </div>
</div>

<script>
    (function () {
        const options = Array.from(document.querySelectorAll(".opt"));
        const search = document.getElementById("search");
        const drop = document.getElementById("drop");
        const chips = document.getElementById("chips");
        const hidden = document.getElementById("hidden-inputs");
        const selected = new Set({{ selected_symptoms|tojson }});

    function renderHidden() {
        hidden.innerHTML = "";
        Array.from(selected).forEach((v) => {
            const i = document.createElement("input");
            i.type = "hidden";
            i.name = "symptoms";
            i.value = v;
            hidden.appendChild(i);
        });
    }

    function renderChips() {
        chips.innerHTML = "";
        Array.from(selected).forEach((v) => {
            const opt = options.find((o) => o.dataset.value === v);
            if (!opt) return;
            const chip = document.createElement("span");
            chip.className = "chip";
            chip.innerHTML = `<span>${opt.dataset.label}</span><button type="button" data-remove="${v}">x</button>`;
            chips.appendChild(chip);
        });
    }

    function sync() {
        options.forEach((o) => o.classList.toggle("active", selected.has(o.dataset.value)));
        renderHidden();
        renderChips();
    }

    options.forEach((o) => o.addEventListener("click", () => {
        const v = o.dataset.value;
        if (selected.has(v)) selected.delete(v); else selected.add(v);
        sync();
        drop.classList.remove("open");
        search.value = "";
        options.forEach((item) => {
            item.style.display = "block";
        });
    }));

    chips.addEventListener("click", (e) => {
        if (!e.target.matches("button[data-remove]")) return;
        selected.delete(e.target.dataset.remove);
        sync();
    });

    search.addEventListener("focus", () => drop.classList.add("open"));
    search.addEventListener("input", () => {
        drop.classList.add("open");
        const q = search.value.toLowerCase().trim();
        options.forEach((o) => {
            o.style.display = o.dataset.label.toLowerCase().includes(q) ? "block" : "none";
        });
    });

    document.addEventListener("click", (e) => {
        if (!e.target.closest("#picker")) drop.classList.remove("open");
    });

    sync();
})();
</script>
{% endblock %}
